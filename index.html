<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>모토몬트 Lucky Draw</title>
<style>
  :root{
    --bg:#e6d9cc;
    --panel:#e6d9cc;
    --fg:#1a1a1a; --muted:#777;
    --shadow:0 10px 30px rgba(0,0,0,.08); --radius:20px;
    --slot-border:#d9d1c7;

    /* 동적 레이아웃 변수(초기값, JS에서 재설정) */
    --slotH: 420px;   /* 각 릴의 보이는 높이(=한 칸) */
    --giftH: 200px;   /* 하단 배너 높이 */
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
  html,body{height:100%; overflow:hidden;} /* 스크롤/드래그 제거 */
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Malgun Gothic,Helvetica,Arial,"Noto Sans KR",sans-serif;
  }
  .wrap{min-height:100dvh; padding:20px; display:flex; flex-direction:column; gap:14px; max-width:1200px; margin:0 auto;}

  /* 상단: 좌측 타이틀 이미지 / 우측 로고 이미지 */
  header{display:flex; align-items:flex-start; justify-content:space-between;}
  .title-img{height:54px; width:auto; object-fit:contain;}
  .brand-img{height:48px; width:auto; object-fit:contain;}

  /* 메인 패널 */
  .card{background:var(--panel); border:0; border-radius:var(--radius);}
  .content{padding:8px 0;}

  /* 슬롯머신(세로형) */
  .slot-wrap{
    display:grid; grid-template-columns:repeat(3, minmax(180px, 28vw));
    justify-content:center; gap:28px; margin:6px auto 8px; width:100%;
  }
  .reel{
    position:relative; height:var(--slotH); border-radius:22px; overflow:hidden;
    background:var(--panel); border:2px solid var(--slot-border);
    box-shadow:inset 0 0 0 3px #fff6, inset 0 12px 36px rgba(0,0,0,.06);
  }
  .reel::after, .reel::before{
    content:""; position:absolute; left:0; right:0; height:28px; pointer-events:none;
  }
  .reel::after{ top:0; background:linear-gradient(to bottom, rgba(230,230,230,.75), rgba(230,230,230,0)); }
  .reel::before{ bottom:0; background:linear-gradient(to top, rgba(230,230,230,.75), rgba(230,230,230,0)); }

  .strip{position:absolute; left:0; right:0; top:0; will-change:transform; backface-visibility:hidden;}
  .cell{
    height:var(--slotH); display:flex; align-items:center; justify-content:center; padding:10px;
  }
  .cell img{
    height:100%; width:auto; object-fit:contain; image-rendering:auto;
    filter:drop-shadow(0 2px 6px rgba(0,0,0,.12));
  }

  /* Start 버튼(크게) */
  .action-area{display:flex; justify-content:center; gap:10px; margin:2px 0 8px;}
  button{
    appearance:none; border:none; border-radius:999px;
    padding:20px 60px;           /* 크게 */
    font-size:20px; font-weight:900; /* 크게/두껍게 */
    cursor:pointer; background:#111; color:#fff;
  }
  button:active{transform:translateY(1px);}

  /* 하단 경품 배너(3:1) */
  .gift-area{
    width:100%; max-width:1100px; margin:6px auto 0;
    display:flex; align-items:center; justify-content:center;
    height:var(--giftH);
  }
  .gift-img{
    height:100%; width:auto; display:block; border-radius:16px;
    border:1px solid #dcd4ca;
  }

  /* 결과 모달 */
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:20px; background:rgba(0,0,0,.45);}
  .modal.show{display:flex;}
  .modal-card{width:min(520px,92vw); background:#fff; border-radius:18px; box-shadow:var(--shadow); padding:24px; text-align:center; border:1px solid #eee;}
  .modal h2{margin:0 0 8px; font-size:26px;}
  .modal .prize{font-size:36px; font-weight:800; margin:12px 0 6px;}
  /* 확인 버튼: 가로 유지, 세로 1/4 수준으로 얇게 */
  .close{
    margin-top:10px; background:#f2f2f2; color:#111; border:none; border-radius:999px;
    padding:6px 18px;   /* 얇게 */
    font-size:14px;     /* 작게 */
    font-weight:600; cursor:pointer;
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <!-- ./images/title.png, ./images/logo.png -->
      <img src="./images/title.png" alt="Lucky Draw" class="title-img" />
      <img src="./images/logo.png" alt="MOTOMONT" class="brand-img" />
    </header>

    <section class="card">
      <div class="content">
        <!-- 슬롯머신 -->
        <div class="slot-wrap" id="slotWrap">
          <div class="reel"><div class="strip"></div></div>
          <div class="reel"><div class="strip"></div></div>
          <div class="reel"><div class="strip"></div></div>
        </div>

        <!-- Start 버튼 -->
        <div class="action-area">
          <button id="spinBtn" aria-label="Start">Start</button>
        </div>

        <!-- 하단 경품 배너 -->
        <div class="gift-area">
          <img class="gift-img" src="./images/gift.png" alt="Lucky Draw 경품 안내" />
        </div>
      </div>
    </section>
  </div>

  <!-- 결과 모달 -->
  <div id="resultModal" class="modal" aria-modal="true" role="dialog" aria-labelledby="resTitle">
    <div class="modal-card">
      <h2 id="resTitle">축하합니다!</h2>
      <div id="resPrize" class="prize">1등</div>
      <div class="desc">현장에서 스태프에게 화면을 보여주세요.</div>
      <button id="closeModal" class="close">확인</button>
    </div>
  </div>

<script>
(function(){
  const KEY='roulette_settings_v3'; // 관리자 페이지와 공유
  const defaults = { names:["밀크티 미스트 100ml 1개","밀크티 미스트 20ml 1개","10% 할인 쿠폰"], pcts:[10,30,60], seed:"" };
  function loadSettings(){
    try{
      const s = JSON.parse(localStorage.getItem(KEY)) || defaults;
      return { names: s.names?.length===3?s.names:defaults.names, pcts:s.pcts?.length===3?s.pcts:defaults.pcts, seed:s.seed||"" };
    }catch(e){ return defaults; }
  }
  let settings = loadSettings();

  /* 레이아웃을 뷰포트에 맞춤(아이패드 가로 모드 1스크린) */
  function fitLayout(){
    const vh = (window.visualViewport?.height) || window.innerHeight;
    const header = document.querySelector('header');
    const btnArea = document.querySelector('.action-area');
    const headerH = header?.offsetHeight || 0;
    const btnH    = btnArea?.offsetHeight || 0;

    const MARGIN_PAD = 20 + 20 + 8; // wrap top/bottom + content 여유
    const giftH = Math.round(Math.min(Math.max(vh * 0.18, 120), 220)); // 18%~220px
    let available = vh - headerH - btnH - giftH - MARGIN_PAD;
    const slotH = Math.round(Math.min(Math.max(available, 260), 460));  // 260~460px

    document.documentElement.style.setProperty('--slotH', slotH + 'px');
    document.documentElement.style.setProperty('--giftH', giftH + 'px');
  }

  // 심볼 정의 (0=100ml, 1=20ml, 2=coupon)
  const SYMBOLS = [
    {id:0, src:'./images/100.png',   name:settings.names[0]},
    {id:1, src:'./images/20.png',    name:settings.names[1]},
    {id:2, src:'./images/coupon.png',name:settings.names[2]},
  ];

  const reels = Array.from(document.querySelectorAll('.reel .strip'));
  const reelBoxes = Array.from(document.querySelectorAll('.reel'));

  // 스트립 길이(여유 있게, 이미지 사라짐 방지)
  const REP = 90;
  const STRIP_LEN = SYMBOLS.length * REP;

  function cellHeight(){ return reelBoxes[0].clientHeight || parseInt(getComputedStyle(document.documentElement).getPropertyValue('--slotH')) || 420; }

  function buildStrips(){
    const H = cellHeight();
    reels.forEach(strip=>{
      strip.innerHTML='';
      const order = [];
      for(let r=0;r<REP;r++){ order.push(...SYMBOLS); }
      for(const sym of order){
        const cell = document.createElement('div'); cell.className='cell';
        cell.style.height = H + 'px';
        const img = document.createElement('img'); img.src=sym.src; img.alt=sym.name;
        cell.appendChild(img); strip.appendChild(cell);
      }
      // 시작 위치: 스트립 중앙 근처 + 셀 배수
      const startIndexBase = Math.floor(STRIP_LEN/2);
      const jitter = Math.floor((STRIP_LEN/12) * Math.random());
      const startIndex = startIndexBase + jitter;
      strip.style.transform = `translateY(${-startIndex*H}px)`;
    });
  }

  // 최초 레이아웃/빌드 + 리스너
  const relayout = () => { fitLayout(); buildStrips(); };
  relayout();
  window.addEventListener('resize', relayout);
  window.addEventListener('orientationchange', relayout);
  if (window.visualViewport) window.visualViewport.addEventListener('resize', relayout);

  // 확률 추첨
  function seededRandomFactory(seed){
    if(!seed) return ()=> Math.random();
    let h=2166136261>>>0;
    for(let i=0;i<seed.length;i++){ h^=seed.charCodeAt(i); h=Math.imul(h,16777619); }
    return ()=>{ h^=h<<13; h^=h>>>17; h^=h<<5; return ((h>>>0)%1e9)/1e9; };
  }
  function chooseOutcome(){
    const rand = seededRandomFactory(settings.seed);
    const r = rand();
    const p1=settings.pcts[0]/100, p2=(settings.pcts[0]+settings.pcts[1])/100;
    const grade = (r<p1)?0:(r<p2?1:2); // 0=1등,1=2등,2=3등

    let result;
    if(grade===0){        // 100ml ×3
      result=[0,0,0];
    }else if(grade===1){  // 20ml ×3
      result=[1,1,1];
    }else{
      // 3등: (1) coupon×3 또는 (2) 혼합(단, 100×3/20×3 제외)
      if(Math.random()<0.35){ result=[2,2,2]; }
      else{
        const randInt=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
        do{
          result=[randInt(0,2), randInt(0,2), randInt(0,2)];
        }while( (result[0]===result[1] && result[1]===result[2] && result[0]!==2) );
      }
    }
    return { grade, result };
  }

  const mod = (n,m)=>((n%m)+m)%m;

  const spinBtn=document.getElementById('spinBtn');
  const modal=document.getElementById('resultModal');
  const closeModal=document.getElementById('closeModal');
  const resPrize=document.getElementById('resPrize');

  let spinning=false;

  spinBtn.addEventListener('click', async ()=>{
    if(spinning) return;
    const sum = settings.pcts.reduce((a,b)=>a+b,0);
    if(sum!==100){ alert('관리자 설정의 확률 합계가 100%가 아닙니다.'); return; }
    spinning=true;

    const {grade, result} = chooseOutcome();

    // 타이밍: 0~2s 빠르게, 2~4s 감속, 4~5s 정지 유지
    const FAST_MS = 2000, SLOW_MS = 2000, HOLD_MS = 1000, TOTAL = FAST_MS + SLOW_MS;
    const H = cellHeight();

    // 시작 오프셋/인덱스
    const startY = reels.map(strip=>{
      const m = /translateY\((-?\d+)px\)/.exec(strip.style.transform||'');
      return m ? parseInt(m[1],10) : 0;
    });
    const startIndex = startY.map(y => Math.round(-y / H)); // translateY = -index*H
    const startSym = startIndex.map(i => mod(i, 3));

    // 릴별 루프 수(같은 속도, 결과 타이밍만 소폭 차이)
    const baseLoops = 18;              // 3칸=1바퀴 기준
    const loopDelta = [0, 2, 4];

    // 목표까지 이동할 '칸 수' (아래로 이동 = 인덱스 감소)
    // k ≡ (현재심볼 - 목표심볼) (mod 3)  ← 부호 수정 반영
    const kSteps = startSym.map((cs, i) => {
      const kMod = mod(cs - result[i], 3);
      return kMod + (baseLoops + loopDelta[i]) * 3;
    });

    // 최종 타겟 Y (translateY 증가 = 아래로 이동)
    const targetY = kSteps.map((k, i) => startY[i] + k * H);
    const distances = targetY.map((ty, i)=> ty - startY[i]); // > 0

    // 빠른 구간 속도(모든 릴 동일): 2초 동안 총 거리의 60%
    const vFast = distances[0] * 0.60 / (FAST_MS/1000);

    const startTime = performance.now();
    await new Promise(resolve=>{
      function frame(now){
        const t = now - startTime;

        reels.forEach((strip, i)=>{
          let y;
          if(t < FAST_MS){
            y = startY[i] + vFast * (t/1000);   // 위→아래
            if(y > targetY[i]) y = targetY[i] - 1; // 초과 방지
          }else{
            const t2 = t - FAST_MS;
            const p2 = Math.min(1, t2 / SLOW_MS);
            const easeOut = 1 - Math.pow(1 - p2, 3);

            const yFastEnd = startY[i] + vFast*(FAST_MS/1000); // 60%
            const from = Math.min(yFastEnd, targetY[i] - 1);
            y = from + (targetY[i] - from) * easeOut;
          }
          strip.style.transform = `translateY(${y}px)`;
        });

        if(t < TOTAL) requestAnimationFrame(frame);
        else resolve();
      }
      requestAnimationFrame(frame);
    });

    // 정지 화면 1초 유지 후 결과 팝업
    reels.forEach((strip, i)=>{ strip.style.transform = `translateY(${targetY[i]}px)`; });
    await new Promise(r=>setTimeout(r, HOLD_MS));

    resPrize.textContent = settings.names[grade] || `${grade+1}등`;

    // 참여 횟수 카운트(태블릿 한 대 기준)
    let count = parseInt(localStorage.getItem('roulette_count') || '0', 10);
    count++;
    localStorage.setItem('roulette_count', String(count));

    modal.classList.add('show');
  });

  closeModal.addEventListener('click', ()=>{
    modal.classList.remove('show');
    relayout();      // 레이아웃/스트립 재구성
    spinning=false;
  });
  modal.addEventListener('click', e=>{ if(e.target===modal) closeModal.click(); });
})();
</script>
</body>
</html>